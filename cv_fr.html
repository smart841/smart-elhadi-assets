<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Remplissez et téléchargez votre CV en français facilement. Aucun stockage de données personnelles.">
    <title>Édition et Téléchargement de CV</title>
    <!-- تحميل المكتبات بشكل غير متزامن -->
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script async src="https://cdn.jsdelivr.net/npm/@pdf-lib/fontkit@0.0.3/dist/fontkit.umd.js"></script>
    <script async src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.7/purify.min.js"></script>
    <style>
        body {
            font-family: 'Tajawal', Arial, sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            max-width: 700px;
            width: 90%;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        h2 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 30px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .form-row {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .form-row > .form-group {
            flex: 1;
            min-width: 200px;
            margin-bottom: 0;
        }
        label {
            font-weight: 600;
            color: #34495e;
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
        }
        input, .image-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: left;
            font-weight: 500;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: #f9f9f9;
        }
        input[type="date"] {
            text-align: left;
            direction: ltr;
        }
        input:focus, .image-input:focus {
            border-color: #007BFF;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
            outline: none;
        }
        button {
            background: linear-gradient(45deg, #007BFF, #00d2d3);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: transform 0.2s, background 0.3s;
            width: 100%;
            max-width: 300px;
            margin-top: 20px;
        }
        button:hover {
            transform: translateY(-2px);
            background: linear-gradient(45deg, #0056b3, #00a5a5);
        }
        button:active {
            transform: translateY(0);
        }
        .add-button {
            background: linear-gradient(45deg, #28a745, #34d058);
            max-width: 200px;
            margin: 10px auto;
        }
        .add-button:hover {
            background: linear-gradient(45deg, #218838, #28a745);
        }
        .message {
            margin-top: 15px;
            color: #28a745;
            font-weight: 500;
            display: none;
        }
        .image-input {
            cursor: pointer;
            background: #fff;
        }
        .image-input::-webkit-file-upload-button {
            background: #007BFF;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .image-input::-webkit-file-upload-button:hover {
            background: #0056b3;
        }
        .g-recaptcha {
            margin: 20px 0;
        }
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        .warning-message {
            color: #dc3545;
            font-weight: bold;
            font-size: 16px;
            margin-top: 20px;
            text-align: center;
            direction: rtl;
        }
        * {
            box-sizing: border-box;
        }
    </style>
</head>
<body oncontextmenu="return false;" onkeydown="return protectKey(event);" onload="loadFormFields()">
    <div class="container" id="formContainer">
        <h2>Remplissez le CV et téléchargez-le</h2>
        <div class="form-group">
            <label for="imageUpload">Ajouter une photo</label>
            <input type="file" id="imageUpload" class="image-input" accept="image/*" onchange="validateImage(this)">
            <div id="imageError" class="error-message"></div>
        </div>
        <div id="recaptcha-container" class="g-recaptcha"></div>
        <button onclick="fillPDF(event)">Télécharger le fichier modifié</button>
        <div id="statusMessage" class="message"></div>
        <!-- رسالة التحذير بالعربية -->
        <div class="warning-message">
            هذا النموذج مخصص فقط لتعبئة الوثائق الإدارية. لا يتم تخزين أي معلومات شخصية، مما يضمن حماية خصوصيتك وسلامة بياناتك.
        </div>
    </div>

    <script>
        const API_KEY = 'my_secure_key_abdelhadimebarki0775203040'; // مفتاح الأمان
        let recaptchaReady = false;

        // تحميل reCAPTCHA
        function onRecaptchaLoad() {
            recaptchaReady = true;
            grecaptcha.render('recaptcha-container', { 'sitekey': '6LdzVtwqAAAAALfPi8CN8EA2nn91wO1KDVz8j1-Y' });
        }

        // حماية من مفاتيح الاختصار
        function protectKey(event) {
            const key = event.keyCode || event.which;
            if (event.ctrlKey && (key === 85 || key === 83) || key === 123) {
                return false;
            }
            return true;
        }

        // تعريف الحقول
        const fields = {
            "Nom": "Nom", "Prénom": "Prénom", "Adresse": "Adresse", "Téléphone": "Téléphone",
            "Email": "E-mail", "ÉtatCivil": "État Civil", "Nationalité": "Nationalité",
            "DateDeNaissance": "Date de Naissance", "LieuDeNaissance": "Lieu de Naissance",
            "Formation1": "Formation et Qualifications 1", "Formation2": "Formation et Qualifications 2",
            "Formation3": "Formation et Qualifications 3", "Formation4": "Formation et Qualifications 4",
            "Formation5": "Formation et Qualifications 5", "Expérience1": "Expérience Professionnelle 1",
            "Expérience2": "Expérience Professionnelle 2", "Expérience3": "Expérience Professionnelle 3",
            "Expérience4": "Expérience Professionnelle 4", "Expérience5": "Expérience Professionnelle 5",
            "Compétences1": "Compétences 1", "Compétences2": "Compétences 2", "Compétences3": "Compétences 3",
            "Compétences4": "Compétences 4", "Compétences5": "Compétences 5"
        };

        let formCount = 1, expCount = 1, compCount = 1;

        // تحميل الحقول ديناميكيًا
        function loadFormFields() {
            const container = document.getElementById("formContainer");
            const elements = [];
            elements.push(createFormRow(
                `<div class="form-group"><label for="Nom">${fields.Nom}</label><input type="text" id="Nom" oninput="sanitize(this)"><div class="error-message" id="NomError"></div></div>`,
                `<div class="form-group"><label for="Prénom">${fields.Prénom}</label><input type="text" id="Prénom" oninput="sanitize(this)"><div class="error-message" id="PrénomError"></div></div>`
            ));
            elements.push(createFormRow(
                `<div class="form-group"><label for="DateDeNaissance">${fields.DateDeNaissance}</label><input type="date" id="DateDeNaissance" oninput="sanitize(this)"><div class="error-message" id="DateDeNaissanceError"></div></div>`,
                `<div class="form-group"><label for="LieuDeNaissance">${fields.LieuDeNaissance}</label><input type="text" id="LieuDeNaissance" oninput="sanitize(this)"><div class="error-message" id="LieuDeNaissanceError"></div></div>`
            ));
            elements.push(createFormGroup(`<label for="Adresse">${fields.Adresse}</label><input type="text" id="Adresse" oninput="sanitize(this)"><div class="error-message" id="AdresseError"></div>`));
            elements.push(createFormRow(
                `<div class="form-group"><label for="ÉtatCivil">${fields.ÉtatCivil}</label><input type="text" id="ÉtatCivil" oninput="sanitize(this)"><div class="error-message" id="ÉtatCivilError"></div></div>`,
                `<div class="form-group"><label for="Nationalité">${fields.Nationalité}</label><input type="text" id="Nationalité" oninput="sanitize(this)"><div class="error-message" id="NationalitéError"></div></div>`
            ));
            elements.push(createFormRow(
                `<div class="form-group"><label for="Téléphone">${fields.Téléphone}</label><input type="text" id="Téléphone" dir="ltr" oninput="sanitize(this)"><div class="error-message" id="TéléphoneError"></div></div>`,
                `<div class="form-group"><label for="Email">${fields.Email}</label><input type="text" id="Email" dir="ltr" oninput="sanitize(this)"><div class="error-message" id="EmailError"></div></div>`
            ));
            elements.push(createFormGroup(`<label for="Formation1">${fields.Formation1}</label><input type="text" id="Formation1" oninput="sanitize(this)"><div class="error-message" id="Formation1Error"></div>`));
            elements.push(createButton("addFormationBtn", "Ajouter une formation", addFormationField));
            elements.push(createFormGroup(`<label for="Expérience1">${fields.Expérience1}</label><input type="text" id="Expérience1" oninput="sanitize(this)"><div class="error-message" id="Expérience1Error"></div>`));
            elements.push(createButton("addExperienceBtn", "Ajouter une expérience", addExperienceField));
            elements.push(createFormGroup(`<label for="Compétences1">${fields.Compétences1}</label><input type="text" id="Compétences1" oninput="sanitize(this)"><div class="error-message" id="Compétences1Error"></div>`));
            elements.push(createButton("addCompétencesBtn", "Ajouter une compétence", addCompétencesField));
            elements.forEach(element => container.insertBefore(element, document.getElementById('recaptcha-container')));
        }

        // إنشاء صف نموذج
        function createFormRow(...fields) {
            const row = document.createElement("div");
            row.className = "form-row";
            row.innerHTML = fields.join('');
            return row;
        }

        // إنشاء مجموعة نموذج
        function createFormGroup(html) {
            const group = document.createElement("div");
            group.className = "form-group";
            group.innerHTML = html;
            return group;
        }

        // إنشاء زر
        function createButton(id, text, onclick) {
            const btn = document.createElement("button");
            btn.className = "add-button";
            btn.id = id;
            btn.innerText = text;
            btn.onclick = onclick;
            return btn;
        }

        // إضافة حقول ديناميكية
        function addFormationField() {
            if (formCount < 5) {
                formCount++;
                const field = createFormGroup(`<label for="Formation${formCount}">${fields[`Formation${formCount}`]}</label><input type="text" id="Formation${formCount}" oninput="sanitize(this)"><div class="error-message" id="Formation${formCount}Error"></div>`);
                document.getElementById('addFormationBtn').before(field);
            }
            if (formCount === 5) document.getElementById('addFormationBtn').style.display = 'none';
        }

        function addExperienceField() {
            if (expCount < 5) {
                expCount++;
                const field = createFormGroup(`<label for="Expérience${expCount}">${fields[`Expérience${expCount}`]}</label><input type="text" id="Expérience${expCount}" oninput="sanitize(this)"><div class="error-message" id="Expérience${expCount}Error"></div>`);
                document.getElementById('addExperienceBtn').before(field);
            }
            if (expCount === 5) document.getElementById('addExperienceBtn').style.display = 'none';
        }

        function addCompétencesField() {
            if (compCount < 5) {
                compCount++;
                const field = createFormGroup(`<label for="Compétences${compCount}">${fields[`Compétences${compCount}`]}</label><input type="text" id="Compétences${compCount}" oninput="sanitize(this)"><div class="error-message" id="Compétences${compCount}Error"></div>`);
                document.getElementById('addCompétencesBtn').before(field);
            }
            if (compCount === 5) document.getElementById('addCompétencesBtn').style.display = 'none';
        }

        // تنظيف المدخلات
        function sanitize(input) {
            input.value = DOMPurify.sanitize(input.value);
        }

        // التحقق من الصورة
        function validateImage(input) {
            const file = input.files[0], error = document.getElementById('imageError');
            if (file && !file.type.startsWith('image/')) {
                error.style.display = 'block';
                error.textContent = 'Veuillez télécharger une image uniquement !';
                input.value = '';
            } else {
                error.style.display = 'none';
            }
        }

        // تعبئة وتحميل PDF
        async function fillPDF(event) {
            event.preventDefault();
            if (!recaptchaReady) {
                alert("reCAPTCHA en cours de chargement, veuillez réessayer plus tard !");
                return;
            }
            const recaptchaResponse = grecaptcha.getResponse();
            if (!recaptchaResponse) {
                alert("Veuillez vérifier que vous n'êtes pas un robot !");
                return;
            }

            const requiredFields = ['Nom', 'Prénom', 'Téléphone', 'Email'];
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                const error = document.getElementById(`${fieldId}Error`);
                if (!field.value.trim()) {
                    error.style.display = 'block';
                    error.textContent = `Le champ ${fields[fieldId]} est requis !`;
                    return;
                } else {
                    error.style.display = 'none';
                }
            }

            try {
                // إعداد البيانات مع مفتاح الأمان
                const formData = new FormData();
                formData.append('filename', 'cv_fr.pdf');
                formData.append('g-recaptcha-response', recaptchaResponse);
                formData.append('api_key', API_KEY);

                console.log('إرسال طلب إلى get_pdf.php:', {
                    filename: 'cv_fr.pdf',
                    'g-recaptcha-response': recaptchaResponse,
                    api_key: API_KEY
                });

                const response = await fetch('/get_pdf.php', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`فشل الطلب إلى get_pdf.php: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                console.log('استجابة get_pdf.php:', result);

                if (result.error) {
                    throw new Error(result.error);
                }

                const pdfBytes = Uint8Array.from(atob(result.pdf), c => c.charCodeAt(0));
                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);

                pdfDoc.registerFontkit(window.fontkit);
                const fontBytes = await fetch("/wp-content/uploads/fonts/Arial.ttf", { cache: "no-cache" }).then(res => {
                    if (!res.ok) throw new Error("Échec du chargement de la police");
                    return res.arrayBuffer();
                });
                const customFont = await pdfDoc.embedFont(fontBytes, { subset: true });

                const form = pdfDoc.getForm();
                const fieldMapping = {
                    "Nom": "Nom", "Prénom": "Prénom", "Adresse": "Adresse", "Téléphone": "Téléphone",
                    "Email": "E-mail", "ÉtatCivil": "État Civil", "Nationalité": "Nationalité",
                    "DateDeNaissance": "Date de Naissance", "LieuDeNaissance": "Lieu de Naissance",
                    "Formation1": "Formation et Qualifications 1", "Formation2": "Formation et Qualifications 2",
                    "Formation3": "Formation et Qualifications 3", "Formation4": "Formation et Qualifications 4",
                    "Formation5": "Formation et Qualifications 5", "Expérience1": "Expérience Professionnelle 1",
                    "Expérience2": "Expérience Professionnelle 2", "Expérience3": "Expérience Professionnelle 3",
                    "Expérience4": "Expérience Professionnelle 4", "Expérience5": "Expérience Professionnelle 5",
                    "Compétences1": "Compétences 1", "Compétences2": "Compétences 2", "Compétences3": "Compétences 3",
                    "Compétences4": "Compétences 4", "Compétences5": "Compétences 5"
                };

                for (const inputId in fieldMapping) {
                    const input = document.getElementById(inputId);
                    if (input) {
                        const pdfFieldName = fieldMapping[inputId];
                        const field = form.getTextField(pdfFieldName);
                        if (field) {
                            let value = input.value.trim() === "" ? "/" : input.value.trim();
                            if (inputId === "DateDeNaissance" && value !== "/") {
                                const dateParts = value.split('-');
                                value = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                            }
                            field.setText(value);
                            field.updateAppearances(customFont);
                            field.enableReadOnly();
                        }
                    }
                }

                const imageInput = document.getElementById("imageUpload");
                if (imageInput.files.length > 0) {
                    const imageFile = imageInput.files[0];
                    if (imageFile.type.startsWith('image/')) {
                        const imageBytes = await imageFile.arrayBuffer();
                        const image = await pdfDoc.embedJpg(imageBytes);
                        const imageField = form.getButton("PHOTO");
                        if (imageField) imageField.setImage(image);
                    }
                }

                form.flatten();
                const modifiedPdfBytes = await pdfDoc.save();
                download(modifiedPdfBytes, "cv_modifié.pdf", "application/pdf");

                const message = document.getElementById('statusMessage');
                message.style.display = 'block';
                message.textContent = 'Fichier téléchargé avec succès !';
                setTimeout(() => message.style.display = 'none', 3000);

                grecaptcha.reset();
            } catch (err) {
                console.error("Erreur survenue :", err);
                alert("Une erreur s'est produite lors du traitement du fichier: " + err.message);
            }
        }

        // تحميل الملف
        function download(data, filename, type) {
            const blob = new Blob([data], { type });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>